# FCEP (FuCube Ethernet Protocol) 协议设计文档
### ~~技术能力不足，本项目暂时停更~~
### 技术文档还是可以看看的，万一可以实现呢？
### 本项目允许任何人修改
### 现有的python文件是一个简单的收发示例
## 一、协议基本信息

- **协议名称**：FCEP (FuCube Ethernet Protocol)
- **版本**：v0.3
- **基础协议**：支持 TCP 和 UDP
- **支持的加密方式**：
  - AES-128-CBC
  - AES-128-CFB
  - AES-256-CBC
  - AES-256-CFB
- **功能**：
  - **伪造报头**：
    - **UDP**：可选类型为 `none`、`ftp`、`rdp`、`mcpe`、`dns`、`smtp`
    - **TCP**：可选类型为 `none`、`rdp`、`mcje`、`ssh`、`frp`、`http`
  - **WebSocket**（仅 TCP 可用）
  - **多路复用（MUX）**：
    - 每个数据包附带一个唯一的 Stream ID，用以标识当前数据属于哪个流。
    - 服务器根据 Stream ID 将数据包分发给相应的会话或处理逻辑。
  - **Gzip 压缩**（仅 TCP 可用）
  - **自适应重传机制**：
    - 在数据包丢失时，协议自动基于时间戳和序列号进行重传。
    - 使用序列号和时间戳来标识数据包。
  - **连接恢复**：
    - 在连接断开或网络中断时，自动恢复连接，并重新发送丢失的数据包。
  - **流量控制**：
    - 基于用户 Token 或 ID 对不同用户的流量进行限速，确保公平分配带宽。
  - **DNS 解析功能**：
    - 通过 VPN 服务提供 DNS 解析功能，增强隐私保护，防止 DNS 劫持。
- **默认端口**：11451（可调）
- **默认报文内容**：如果伪造类型为 `none`，则报头为 "I love you <3"(可自定义)
- **心跳包**：每 15 秒发送一次心跳包（可调）

---

## 二、FCEP 报文结构

每个 FCEP 报文的结构如下：

```text
+-------------------+
| Version (1 byte) | // 协议版本
+-------------------+
| Packet Type (1 byte) | // 数据包类型（例如：数据包、控制包等）
+-------------------+
| Token Length (1 byte) | // Token 长度 N
+-------------------+
| Token (16 bytes) | // 用户 Token
+-------------------+
| Stream ID (2 bytes) | // 多路复用流 ID
+-------------------+
| Payload Length (2 bytes) | // 负载长度
+-------------------+
| Checksum (2 bytes) | // 校验和
+-------------------+
| fakePayload (variable bytes) | // 伪造报头
+-------------------+
| Payload (variable bytes) | // 加密数据
+-------------------+
```

## 三、字段说明

1. **Version (1 byte)**:
   - 表示协议的版本号，以便于将来的版本控制。

2. **Packet Type (1 byte)**:
   - 指示数据包的类型，例如：
     - 0x01：数据包
     - 0x02：心跳包
     - 0x03：控制包
     - 0x04：错误包

3. **Token Length (1 byte)**:
   - 表示 token 的长度，以字节为单位。这有助于接收方正确提取 token。

4. **Token (16 bytes)**:
   - 用户的身份验证 token，确保只有授权用户可以发送请求。
   - 例如，可以是一个随机字符串或 JWT。

5. **Stream ID (2 bytes)**:
   - 用于标识多路复用的数据流。每个流都有一个唯一的 ID。

6. **Payload Length (2 bytes)**:
   - 表示负载数据的长度，以字节为单位。

7. **Checksum (2 bytes)**:
   - 简单的校验和，用于验证数据包的完整性。可以使用简单的加法和或 CRC。

8. **fakePayload (variable bytes)**:
   - 伪造的报文负载，根据选择的指定报文头复制到这里（如果是 `none` 则为 "I love you <3"）。

9. **Payload (variable bytes)**:
   - 实际数据负载，可以是加密后的数据或伪造报文内容。例如，HTTP 请求或其他应用数据。

---

## 四、协议实现建议

1. **报文构造与解析**：
   - 实现报文的构造和解析逻辑，以便于在客户端和服务器端准确处理 FCEP 报文。

2. **心跳机制**：
   - 定时发送心跳包，确保连接的活跃性，防止超时断开。

3. **流量控制与限速**：
   - 基于用户的 token 或 ID 实现流量控制，动态调整带宽分配。

4. **DNS 解析**：
   - 实现 DNS 请求的封装和响应处理，确保 DNS 请求通过 VPN 隧道进行。

5. **自适应重传机制**：
   - 实现基于序列号和时间戳的自动重传逻辑。

6. **连接恢复**：
   - 根据网络状态定期检查连接并在断开时尝试恢复。

---

